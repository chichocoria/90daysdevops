name: Update docker-compose tag and create PR

on:
  workflow_run:
    workflows: ["Build and Push Docker Images"]
    branches: [master]
    types:
      - completed

# ‚Üì‚Üì‚Üì Permisos expl√≠citos para el token ‚Üì‚Üì‚Üì
permissions:
  contents: write  # Permite hacer push
  pull-requests: write  # Permite crear PRs

jobs:
  update-tag-and-pr:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          ref: master  # Checkout de la rama base

      - name: Set tag
        run: echo "TAG=sha-${GITHUB_SHA::7}" >> $GITHUB_ENV

      - name: Replace tags in compose
        run: |
          sed -i "s|ghcr.io/.*/vote:.*|ghcr.io/${{ github.repository_owner }}/vote:${TAG}|g" desafio-semana-3/docker-compose.staging.yml
          sed -i "s|ghcr.io/.*/result:.*|ghcr.io/${{ github.repository_owner }}/result:${TAG}|g" desafio-semana-3/docker-compose.staging.yml
          sed -i "s|ghcr.io/.*/worker:.*|ghcr.io/${{ github.repository_owner }}/worker:${TAG}|g" desafio-semana-3/docker-compose.staging.yml

      - name: Create new branch
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git checkout -b "update-staging-tags-${TAG}"  # Rama nueva con el tag

      - name: Commit changes
        run: |
          git add desafio-semana-3/docker-compose.staging.yml
          git commit -m "üîÅ Update staging tags to ${TAG}"

      - name: Push branch
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git remote set-url origin https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}
          git push origin "update-staging-tags-${TAG}"

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          title: "Update Staging Tags: ${TAG}"
          body: "Auto-generated PR to update Docker tags in staging compose file."
          base: master  # Rama destino del PR
          branch: "update-staging-tags-${TAG}"  # Rama origen
          labels: "automated,staging"