name: Update docker-compose tag

on:
  workflow_run:
    workflows: ["Build and Push Docker Images"]
    branches: [master]
    types:
      - completed

jobs:
  update-tag:
    # Solo ejecutar si el workflow anterior fue exitoso
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          ref: develop

      - name: Set tag
        run: echo "TAG=sha-${GITHUB_SHA::7}" >> $GITHUB_ENV

      - name: Replace tags in compose
        run: |
          sed -i "s|ghcr.io/.*/vote:.*|ghcr.io/${{ github.repository_owner }}/vote:${TAG}|g" desafio-semana-3/docker-compose.staging.yml
          sed -i "s|ghcr.io/.*/result:.*|ghcr.io/${{ github.repository_owner }}/result:${TAG}|g" desafio-semana-3/docker-compose.staging.yml
          sed -i "s|ghcr.io/.*/worker:.*|ghcr.io/${{ github.repository_owner }}/worker:${TAG}|g" desafio-semana-3/docker-compose.staging.yml

      - name: Commit changes
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add desafio-semana-3/docker-compose.staging.yml
          git commit -m "üîÅ Update staging tag ${TAG}" || echo "No changes"
          git remote set-url origin https://x-access-token:${GH_TOKEN}@github.com/${{ github.repository }}
          git push origin develop
