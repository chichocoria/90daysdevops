# .github/workflows/deploy-staging.yml
#prueba
name: Deploy to Staging

on:
  workflow_run:
    workflows: ["CI Pipeline"]
    types: [completed]
    branches: [develop]

jobs:
  deploy:
    runs-on: [staging]

    steps:
      - uses: actions/checkout@v4
        with:
          ref: "develop"

      - name: Extraer TAG del commit
        run: echo "IMAGE_TAG=${GITHUB_SHA::7}" > desafio-semana-3/.env.staging

      - name: Login a GHCR
        run: echo "${{ secrets.GHCR_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Docker Compose - Pull & Deploy
        run: |
          docker-compose --env-file desafio-semana-3/.env.staging -f desafio-semana-3/docker-compose.staging.yml down
          docker-compose --env-file desafio-semana-3/.env.staging -f desafio-semana-3/docker-compose.staging.yml pull
          docker-compose --env-file desafio-semana-3/.env.staging -f desafio-semana-3/docker-compose.staging.yml up -d

      - name: Esperar que los servicios est√©n listos
        run: sleep 10

      - name: Health check
        run: bash desafio-semana-3/scripts/health-check.sh http://localhost:80

      - name: Smoke test
        run: curl -f http://localhost:3000 || exit 1

